#!/usr/bin/env python3

import argparse
import subprocess
import json
import os
import shutil

from pathlib import Path

USE_AFTER_FREE = 'USE_AFTER_FREE'
USE_AFTER_DELETE = 'USE_AFTER_DELETE'

RESULT_DIR = 'infer-result'


def run_tracer(package, script):
    os.mkdir(RESULT_DIR)

    subprocess.run(
        [script, '-p', package, '-o', RESULT_DIR, '-i', '--pulse-only'])

    report = open(
        Path('.') / RESULT_DIR / package / 'infer-out' / 'report.json', 'r')
    report_json = json.load(report)
    uaf_lines = []
    for alarm in report_json:
        bug_type = alarm['bug_type']
        if bug_type == USE_AFTER_FREE or bug_type == USE_AFTER_DELETE:
            uaf_lines.append(alarm['line'])

    infer_options = '--api-misuse-only --api-misuse-max-fp 5 --api-misuse-max-set 10'
    for line in uaf_lines:
        infer_options += f' --uaf-lines {line}'
    subprocess.run(
        [script, '-p', package, '-o', RESULT_DIR, '-i', infer_options])

    subprocess.run(['./rank/tracer', RESULT_DIR, '-feat', 'high'])

    shutil.rmtree(RESULT_DIR)


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('--debian',
                        default=False,
                        action=argparse.BooleanOptionalAction)
    parser.add_argument('--package')
    args = parser.parse_args()

    if args.debian:
        script = './bin/run-infer-debian.sh'
    else:
        script = './bin/run-infer.sh'

    run_tracer(args.package, script)